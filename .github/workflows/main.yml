name: Ubuntu RDP

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install XRDP and Desktop Environment
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xrdp \
            lxde-core \
            lxde \
            dbus-x11 \
            x11-xserver-utils
          
          # Allow RDP through firewall
          sudo ufw allow 3389/tcp
          sudo ufw --force enable

      - name: Create RDP User with Fixed Password
        run: |
          # Create user with fixed password
          sudo useradd -m -s /bin/bash rdpuser
          echo "rdpuser:*m96319631Z-" | sudo chpasswd
          
          # Add user to sudo group for admin access
          sudo usermod -aG sudo rdpuser
          
          # Configure LXDE for XRDP
          echo "lxsession -s LXDE -e LXDE" | sudo tee /home/rdpuser/.xsession
          sudo chmod +x /home/rdpuser/.xsession
          sudo chown rdpuser:rdpuser /home/rdpuser/.xsession
          
          # Configure XRDP startwm.sh to use LXDE
          sudo bash -c 'cat > /etc/xrdp/startwm.sh' << 'EOF'
#!/bin/sh
if [ -r /etc/default/locale ]; then
  . /etc/default/locale
  export LANG LANGUAGE
fi
lxsession -s LXDE -e LXDE
EOF
          sudo chmod +x /etc/xrdp/startwm.sh
          
          # Verify user creation
          if ! id rdpuser &>/dev/null; then
              echo "User creation failed"
              exit 1
          fi
          
          echo "RDP_CREDS=User: rdpuser | Password: *m96319631Z-" >> $GITHUB_ENV
          
          # Restart XRDP service after configuration
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          
          # Wait a moment for service to fully start
          sleep 5

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          # Start Tailscale with auth key
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-ubuntu-${{ github.run_id }}
          
          # Wait for IP assignment
          retries=0
          while [ -z "$TSIP" ] && [ $retries -lt 10 ]; do
              TSIP=$(tailscale ip -4)
              sleep 5
              retries=$((retries + 1))
          done
          
          if [ -z "$TSIP" ]; then
              echo "Tailscale IP not assigned. Exiting."
              exit 1
          fi
          
          echo "TAILSCALE_IP=$TSIP" >> $GITHUB_ENV
          echo "Tailscale IP: $TSIP"

      - name: Verify RDP Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Check if XRDP is listening on port 3389
          if ! sudo netstat -tuln | grep :3389; then
              echo "XRDP is not listening on port 3389"
              exit 1
          fi
          
          # Check XRDP service status
          sudo systemctl status xrdp
          
          echo "XRDP service is running and listening on port 3389"

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== RDP ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: rdpuser"
          echo "Password: *m96319631Z-"
          echo "=================="
          echo ""
          echo "Desktop Environment: LXDE (lightweight)"
          echo ""
          
          # Keep runner active
          while true; do
              echo "[$(date)] RDP Active - Use workflow cancel button to terminate"
              sleep 300
          done
